#ifndef C_CLASS_H
#define C_CLASS_H

#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>

#define ptr_cast(classname, ptr) (classname*)ptr

//#define new_arg(class_name, func_name, ...) class_name ## _new_ ## func_name(__VA_ARGS__)
#define new(classname) classname ## _constructor((classname*)malloc(sizeof(classname)), NULL)
#define delete(ptr) if (ptr) { \
	invoke(ptr, distructor); \
	free(ptr); \
	ptr = NULL; \
}

#define invoke(ptr, func, ...) (ptr)->ftable->func((ptr), __VA_ARGS__)
#define self_invoke(func, ...) self->ftable->func(self, __VA_ARGS__)

#define pb_mb(ptr, m) (ptr)->pblc->m
#define pv_mb(ptr, m) (ptr)->prvt->m
#define pb(m) pb_mb(self, m)
#define pv(m) self->prvt->m

#define SELF void *s
#define BLOCK_END };
#define METHOD_END }

#define CLASS_DECL(classname) typedef struct classname ## _t classname

#define CLASS_BASE(classname) \
typedef struct classname ## _functable_t classname ## _functable; \
typedef struct classname ## _t classname; \
struct classname ## _t 

#define CLASS(classname) \
CLASS_BASE(classname) {\
	int32_t magic; \
	classname ## _functable *ftable; 

#define CLASS_EXTENDS(classname, parent) \
CLASS_BASE(classname) \
	parent _base; \
	classname ## _functable *ftable; 

#define CLASS_END

/************************类成员变量***************************************************************/
#define PUBLIC_MEMBER_START

#define PUBLIC_MEMBER_END BLOCK_END

/************************类成员函数***************************************************************/
#define DISTRUCTOR void(*distructor)(void*self)	

#define PUBLIC_METHOD_START(classname) \
struct classname ## _functable_t { \
	DISTRUCTOR;

#define PUBLIC_METHOD_END BLOCK_END

#define METHOD(type, func, ...) type(*func)(SELF, __VA_ARGS__)

#define METHOD_DECL(type, classname, func, ...) type classname ## _ ## func(SELF, __VA_ARGS__)
#define METHOD_IMPL(type, classname, func, ...) \
type classname ## _ ## func(SELF, __VA_ARGS__) { \
	classname *self = ptr_cast(classname, s);

/************************类构造、析构函数*********************************************************/
#define CLASS_CONSTRUCTOR_DECL(classname) \
classname *classname ## _constructor \
	(classname *self, void *vftable)

#define CLASS_CONSTRUCTOR_BASE_IMPL(classname) \
inline void classname ## _constructor_fn(classname *self); \
classname *classname ## _constructor \
	(classname *self, void *vftable) { \
	self->magic = magic_ ## classname; \
	self->ftable = vftable ? (classname ## _functable*)vftable : &classname ## _f; \
	classname ## _constructor_fn(self); \
	return self; \
} \
inline void classname ## _constructor_fn(classname *self) 

#define CLASS_CONSTRUCTOR_EXTENDS_IMPL(classname, parent) \
inline void classname ## _constructor_fn(classname *self); \
classname *classname ## _constructor \
	(classname *self, void *vftable) { \
	parent ## _constructor(&(self->_base), &classname ## _f); \
	self->magic = magic_ ## classname; \
	self->ftable = &classname ## _f; \
	classname ## _constructor_fn(self); \
	return self; \
} \
inline void classname ## _constructor_fn(classname *self) 

#define CLASS_DISTRUCTOR_DECL(classname) void classname ## _distructor(SELF)

#define CLASS_DISTRUCTOR_BASE_IMPL(classname) \
inline void classname ## _distructor_fn(classname *self); \
void classname ## _distructor(SELF) { \
	classname *self = ptr_cast(classname, s); \
	classname ## _distructor_fn(self); \
} \
inline void classname ## _distructor_fn(classname *self) 

#define CLASS_DISTRUCTOR_EXTENDS_IMPL(classname, parent) \
inline void classname ## _distructor_fn(classname *self); \
void classname ## _distructor(classname *self) { \
	classname ## _distructor_fn(self); \
	parent ## _distructor(&(self->_base)); \
} \
inline void classname ## _distructor_fn(classname *self) 

/************************类虚函数表初始化*********************************************************/
#define FUNC_TABLE_INIT(classname) \
static classname ## _functable classname ## _f = 

#define FUNC_TABLE_SET(classname, func) classname ## _ ## func

#endif // !C_CLASS_H
